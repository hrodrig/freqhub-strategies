#!/usr/bin/env bash
#
# FreqHub Strategies - Curated Strategies for Freqtrade to be used with FreqHub
# Copyright (C) 2025 - 2026  FreqHub Strategies Contributors
#
# This program is free software: you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with this program.  If not, see <https://www.gnu.org/licenses/>.
#
# ⚖️ DISCLAIMER
# USE AT YOUR OWN RISK
#
# This software is provided "as is", without warranty of any kind, express or implied,
# including but not limited to the warranties of merchantability, fitness for a particular
# purpose and noninfringement. In no event shall the authors or copyright holders be liable
# for any claim, damages or other liability, whether in an action of contract, tort or
# otherwise, arising from, out of or in connection with the software or the use or other
# dealings in the software.
#
# Trading cryptocurrencies involves substantial risk of loss and is not suitable for every
# investor. The value of cryptocurrencies may fluctuate, and you may lose some or all of
# your investment. Past performance is not indicative of future results.

set -euo pipefail

usage() {
  cat <<'EOF'
Usage: bots up|down

Runs up/down for every strategy under ./strategies/*

Notes:
  - For "up", strategies without config.json are skipped (warning).
  - Uses ./scripts/bot for each strategy.
EOF
}

if [[ "${1:-}" == "-h" || "${1:-}" == "--help" ]]; then
  usage
  exit 0
fi

ACTION="${1:-}"
if [[ "${ACTION}" != "up" && "${ACTION}" != "down" ]]; then
  echo "ERROR: missing or invalid action. Use 'up' or 'down'." >&2
  usage >&2
  exit 1
fi

ROOT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"
STRATEGIES_DIR="${ROOT_DIR}/strategies"
BOT_SCRIPT="${ROOT_DIR}/scripts/bot"

if [[ ! -d "${STRATEGIES_DIR}" ]]; then
  echo "ERROR: strategies directory not found: ${STRATEGIES_DIR}" >&2
  exit 1
fi

if [[ ! -x "${BOT_SCRIPT}" ]]; then
  echo "ERROR: bot script not found or not executable: ${BOT_SCRIPT}" >&2
  exit 1
fi

shopt -s nullglob
strategy_dirs=("${STRATEGIES_DIR}"/*)
shopt -u nullglob

if [[ ${#strategy_dirs[@]} -eq 0 ]]; then
  echo "No strategies found under ${STRATEGIES_DIR}"
  exit 0
fi

for strategy_dir in "${strategy_dirs[@]}"; do
  if [[ ! -d "${strategy_dir}" ]]; then
    continue
  fi

  if [[ "${ACTION}" == "up" ]]; then
    if [[ ! -f "${strategy_dir}/config.json" ]]; then
      echo "⚠️  Skipping $(basename "${strategy_dir}"): config.json not found"
      continue
    fi
  fi

  echo "▶ ${ACTION} $(basename "${strategy_dir}")"
  "${BOT_SCRIPT}" "${ACTION}" "${strategy_dir}"
done
